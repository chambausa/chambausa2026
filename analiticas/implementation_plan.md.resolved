# ChambaEnUSA: WordPress → Next.js Migration Plan

Migrating chambaenusa.com from WordPress to Next.js 14 + Supabase to enable scalable automation, better performance, and lower costs.

## User Review Required

> [!IMPORTANT]
> **Migration Strategy Decision**
> 
> I recommend a **phased migration** approach:
> 1. Build new Next.js site on staging subdomain (e.g., `beta.chambaenusa.com`)
> 2. Migrate content in batches (top 30 pages first)
> 3. Test thoroughly with real traffic
> 4. Switch DNS once validated
> 
> **Alternative**: Big bang migration (build everything, switch at once). Riskier but faster.
> 
> **Which approach do you prefer?**

> [!WARNING]
> **SEO Considerations**
> 
> During migration we MUST:
> - Maintain exact same URLs (or setup 301 redirects)
> - Preserve all meta tags and structured data
> - Keep sitemap updated
> - Monitor GSC for crawl errors
> 
> **Estimated downtime**: 0 hours (if using phased approach)

---

## Proposed Changes

### Infrastructure & Setup

#### [NEW] Next.js 14 Project Structure

```
chambaenusa-v2/
├── app/
│   ├── (marketing)/
│   │   ├── page.tsx                    # Homepage
│   │   ├── layout.tsx                  # Root layout
│   │   └── licencia-[oficio]-[estado]/
│   │       └── page.tsx                # Dynamic license pages
│   ├── escuela-[slug]/
│   │   └── page.tsx                    # School detail pages
│   ├── api/
│   │   ├── leads/route.ts              # Lead capture endpoint
│   │   └── generate-content/route.ts   # Claude API integration
│   └── [estado]/
│       └── page.tsx                    # State landing pages
├── components/
│   ├── LeadForm.tsx                    # Reusable lead capture form
│   ├── SchoolTable.tsx                 # School listing component
│   └── SEOHead.tsx                     # Meta tags component
├── lib/
│   ├── supabase.ts                     # Supabase client
│   ├── claude.ts                       # Claude API wrapper
│   └── content-generator.ts            # Content automation
├── scripts/
│   ├── migrate-wordpress.ts            # WordPress export script
│   ├── generate-pages.ts               # Bulk page generation
│   └── scrape-requirements.ts          # Official data scraper
└── supabase/
    └── migrations/
        └── 001_initial_schema.sql      # Database schema
```

**Key decisions**:
- App Router for better performance and SEO
- Route groups for organization
- API routes for serverless functions
- Separate scripts folder for automation

---

#### [NEW] Supabase Database Schema

```sql
-- Core entities
CREATE TABLE trades (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,
  name_es TEXT NOT NULL,
  name_en TEXT,
  avg_salary INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE states (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT UNIQUE NOT NULL,  -- TX, CA, etc.
  name_es TEXT NOT NULL,
  name_en TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE requirements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trade_id UUID REFERENCES trades(id),
  state_id UUID REFERENCES states(id),
  hours_required INTEGER,
  age_min INTEGER,
  fees JSONB,  -- {application: 100, exam: 200, license: 150}
  exam_info TEXT,
  source_url TEXT,
  last_verified TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(trade_id, state_id)
);

CREATE TABLE schools (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  city TEXT,
  state_id UUID REFERENCES states(id),
  phone TEXT,
  website TEXT,
  is_bilingual BOOLEAN DEFAULT false,
  accreditation TEXT[],
  description_md TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE programs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  school_id UUID REFERENCES schools(id),
  trade_id UUID REFERENCES trades(id),
  name TEXT NOT NULL,
  duration_weeks INTEGER,
  cost_usd INTEGER,
  modality TEXT,  -- presencial, online, hibrido
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE pages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,
  trade_id UUID REFERENCES trades(id),
  state_id UUID REFERENCES states(id),
  content_md TEXT NOT NULL,
  meta_title TEXT NOT NULL,
  meta_description TEXT NOT NULL,
  last_updated TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE leads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  state_code TEXT,
  trade_slug TEXT,
  source_page TEXT,
  utm_source TEXT,
  utm_medium TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_pages_slug ON pages(slug);
CREATE INDEX idx_schools_state ON schools(state_id);
CREATE INDEX idx_requirements_trade_state ON requirements(trade_id, state_id);
CREATE INDEX idx_leads_created ON leads(created_at DESC);
```

**Why this schema**:
- Normalized for data integrity
- JSONB for flexible fee structures
- Proper foreign keys for relationships
- Indexes on common queries

---

### Content Migration Strategy

#### [NEW] WordPress Export Script

**File**: `scripts/migrate-wordpress.ts`

```typescript
import { createClient } from '@supabase/supabase-js';
import axios from 'axios';

// Export all WordPress posts via REST API
async function exportWordPressContent() {
  const wpUrl = 'https://chambaenusa.com/wp-json/wp/v2';
  
  // Get all posts
  const posts = await axios.get(`${wpUrl}/posts?per_page=100`);
  
  // Transform to our schema
  const pages = posts.data.map(post => ({
    slug: post.slug,
    content_md: convertHTMLtoMarkdown(post.content.rendered),
    meta_title: post.yoast_head_json?.title || post.title.rendered,
    meta_description: post.yoast_head_json?.description || '',
    // Extract trade/state from slug pattern
    ...parseSlugPattern(post.slug)
  }));
  
  return pages;
}
```

**Steps**:
1. Use WordPress REST API to export all posts
2. Convert HTML content to Markdown
3. Extract structured data from URLs
4. Import to Supabase `pages` table

---

#### [NEW] Dynamic Page Template

**File**: `app/licencia-[oficio]-[estado]/page.tsx`

```typescript
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { notFound } from 'next/navigation';
import Markdown from 'react-markdown';
import LeadForm from '@/components/LeadForm';
import SchoolTable from '@/components/SchoolTable';

export async function generateStaticParams() {
  // Generate all possible trade/state combinations
  const supabase = createServerComponentClient({ cookies });
  const { data: pages } = await supabase.from('pages').select('slug');
  
  return pages?.map(p => {
    const [_, oficio, estado] = p.slug.split('-');
    return { oficio, estado };
  }) || [];
}

export async function generateMetadata({ params }) {
  const supabase = createServerComponentClient({ cookies });
  const slug = `licencia-${params.oficio}-${params.estado}`;
  
  const { data: page } = await supabase
    .from('pages')
    .select('meta_title, meta_description')
    .eq('slug', slug)
    .single();
  
  if (!page) return {};
  
  return {
    title: page.meta_title,
    description: page.meta_description,
  };
}

export default async function LicensePage({ params }) {
  const supabase = createServerComponentClient({ cookies });
  const slug = `licencia-${params.oficio}-${params.estado}`;
  
  // Get page content
  const { data: page } = await supabase
    .from('pages')
    .select(`
      *,
      trade:trades(*),
      state:states(*)
    `)
    .eq('slug', slug)
    .single();
  
  if (!page) notFound();
  
  // Get schools for this trade/state
  const { data: schools } = await supabase
    .from('schools')
    .select(`
      *,
      programs(*)
    `)
    .eq('state_id', page.state_id)
    .eq('programs.trade_id', page.trade_id);
  
  return (
    <article className="max-w-4xl mx-auto px-4 py-12">
      <h1 className="text-4xl font-bold mb-8">
        Licencia de {page.trade.name_es} en {page.state.name_es}
      </h1>
      
      {/* Markdown content */}
      <Markdown className="prose prose-lg">
        {page.content_md}
      </Markdown>
      
      {/* Schools table */}
      <section className="mt-12">
        <h2 className="text-3xl font-bold mb-6">
          Escuelas Bilingües en {page.state.name_es}
        </h2>
        <SchoolTable schools={schools} />
      </section>
      
      {/* Lead capture */}
      <section className="mt-12 bg-blue-50 p-8 rounded-lg">
        <h3 className="text-2xl font-bold mb-4">
          ¿Necesitas ayuda para obtener tu licencia?
        </h3>
        <LeadForm 
          trade={params.oficio}
          state={params.estado}
        />
      </section>
    </article>
  );
}

export const revalidate = 86400; // ISR: revalidate daily
```

**Features**:
- Static generation for all pages (fast!)
- ISR for daily updates
- Dynamic data from Supabase
- Built-in lead capture

---

### Automation & Content Generation

#### [NEW] Content Generator with Claude API

**File**: `lib/content-generator.ts`

```typescript
import Anthropic from '@anthropic-ai/sdk';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

export async function generateLicenseContent({
  trade,
  state,
  requirements,
  schools
}: {
  trade: string;
  state: string;
  requirements: any;
  schools: any[];
}) {
  const prompt = `Genera contenido en español para una página sobre:

Licencia de ${trade} en ${state}

Requisitos oficiales:
- Edad mínima: ${requirements.age_min} años
- Horas requeridas: ${requirements.hours_required}
- Costos: ${JSON.stringify(requirements.fees)}
- Examen: ${requirements.exam_info}

Escuelas disponibles: ${schools.length}

Estructura del contenido:
1. Introducción (2-3 párrafos, enfocado en hispanos)
2. Requisitos paso a paso
3. Proceso de aplicación
4. Costos detallados
5. FAQs (5 preguntas comunes)

Tono: Profesional pero accesible, dirigido a hispanos en USA.
Longitud: 1200-1500 palabras.
Formato: Markdown con headers H2 y H3.`;

  const message = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 4096,
    messages: [{
      role: 'user',
      content: prompt
    }]
  });

  return message.content[0].text;
}
```

**Usage**: Generate content for new trade/state combinations automatically.

---

#### [NEW] Bulk Page Generation Script

**File**: `scripts/generate-pages.ts`

```typescript
import { createClient } from '@supabase/supabase-js';
import { generateLicenseContent } from '@/lib/content-generator';

async function generatePages() {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
  );
  
  // Get all trade/state combinations without pages
  const { data: combinations } = await supabase.rpc('get_missing_pages');
  
  for (const combo of combinations) {
    console.log(`Generating: ${combo.trade_slug}-${combo.state_code}`);
    
    // Get requirements
    const { data: req } = await supabase
      .from('requirements')
      .select('*')
      .eq('trade_id', combo.trade_id)
      .eq('state_id', combo.state_id)
      .single();
    
    // Get schools
    const { data: schools } = await supabase
      .from('schools')
      .select('*')
      .eq('state_id', combo.state_id);
    
    // Generate content
    const content = await generateLicenseContent({
      trade: combo.trade_name,
      state: combo.state_name,
      requirements: req,
      schools
    });
    
    // Save to DB
    await supabase.from('pages').insert({
      slug: `licencia-${combo.trade_slug}-${combo.state_code.toLowerCase()}`,
      trade_id: combo.trade_id,
      state_id: combo.state_id,
      content_md: content,
      meta_title: `Licencia de ${combo.trade_name} en ${combo.state_name} 2026`,
      meta_description: `Requisitos, costos y escuelas bilingües para ${combo.trade_name} en ${combo.state_name}.`
    });
    
    // Rate limit (Claude API)
    await new Promise(resolve => setTimeout(resolve, 2000));
  }
}
```

---

### Lead Capture Implementation

#### [NEW] Lead Form Component

**File**: `components/LeadForm.tsx`

```typescript
'use client';

import { useState } from 'react';

export default function LeadForm({ trade, state }: { trade: string; state: string }) {
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  
  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    setLoading(true);
    
    const formData = new FormData(e.currentTarget);
    const data = {
      name: formData.get('name'),
      email: formData.get('email'),
      phone: formData.get('phone'),
      trade_slug: trade,
      state_code: state,
      source_page: window.location.pathname
    };
    
    const res = await fetch('/api/leads', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    if (res.ok) {
      setSuccess(true);
      // Send confirmation email via Resend
    }
    
    setLoading(false);
  }
  
  if (success) {
    return (
      <div className="bg-green-100 p-6 rounded-lg">
        <h4 className="font-bold text-green-800">¡Gracias!</h4>
        <p>Te enviaremos la guía a tu email en los próximos minutos.</p>
      </div>
    );
  }
  
  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <input
        type="text"
        name="name"
        placeholder="Tu nombre"
        required
        className="w-full px-4 py-2 border rounded"
      />
      <input
        type="email"
        name="email"
        placeholder="Tu email"
        required
        className="w-full px-4 py-2 border rounded"
      />
      <input
        type="tel"
        name="phone"
        placeholder="Teléfono (opcional)"
        className="w-full px-4 py-2 border rounded"
      />
      <button
        type="submit"
        disabled={loading}
        className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700"
      >
        {loading ? 'Enviando...' : 'Descargar Guía Gratis'}
      </button>
    </form>
  );
}
```

---

#### [NEW] Lead Capture API Route

**File**: `app/api/leads/route.ts`

```typescript
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export async function POST(request: Request) {
  const supabase = createRouteHandlerClient({ cookies });
  const data = await request.json();
  
  // Save to Supabase
  const { error } = await supabase.from('leads').insert({
    name: data.name,
    email: data.email,
    phone: data.phone,
    trade_slug: data.trade_slug,
    state_code: data.state_code,
    source_page: data.source_page
  });
  
  if (error) {
    return Response.json({ error: error.message }, { status: 500 });
  }
  
  // Send confirmation email
  await resend.emails.send({
    from: 'ChambaEnUSA <hola@chambaenusa.com>',
    to: data.email,
    subject: `Tu guía para licencia de ${data.trade_slug}`,
    html: `<h1>¡Gracias ${data.name}!</h1>
           <p>Aquí está tu guía completa...</p>`
  });
  
  return Response.json({ success: true });
}
```

---

## Verification Plan

### Automated Tests

```bash
# Build test
npm run build

# Type checking
npm run type-check

# Lighthouse CI (performance)
npm run lighthouse
```

### Manual Verification

1. **Content Migration**:
   - [ ] Verify all 30+ existing pages migrated correctly
   - [ ] Check markdown rendering
   - [ ] Validate meta tags match WordPress

2. **SEO Preservation**:
   - [ ] Test 301 redirects (if URLs change)
   - [ ] Verify sitemap.xml generation
   - [ ] Check robots.txt
   - [ ] Validate structured data (JSON-LD)

3. **Lead Capture**:
   - [ ] Submit test lead
   - [ ] Verify Supabase insert
   - [ ] Check email delivery (Resend)
   - [ ] Test form validation

4. **Performance**:
   - [ ] Lighthouse score > 90
   - [ ] First Contentful Paint < 1.5s
   - [ ] Time to Interactive < 3s

---

## Timeline & Effort Estimate

| Phase | Duration | Effort |
|-------|----------|--------|
| 1. Planning | 1 day | This document |
| 2. Infrastructure Setup | 1 day | Next.js + Supabase init |
| 3. Content Migration | 2 days | Export + import scripts |
| 4. Feature Implementation | 3 days | Templates + forms + automation |
| 5. SEO & Optimization | 1 day | Redirects + meta tags |
| 6. Testing & Launch | 1 day | QA + deployment |
| **TOTAL** | **9 days** | ~40-50 hours |

---

## Cost Comparison

### Current (WordPress)
- Hosting: ~$20-50/month
- Plugins: ~$10-30/month
- **Total**: ~$30-80/month

### New (Next.js + Supabase)
- Vercel: $0 (free tier, then $20/month if needed)
- Supabase: $0 (free tier up to 500MB, then $25/month)
- Resend: $0 (free tier 100 emails/day, then $20/month)
- Claude API: ~$10-30/month (for content generation)
- **Total**: $0-10/month initially, ~$50-95/month at scale

**Savings**: Similar cost but MUCH better performance and scalability.

---

## Next Steps

1. **Approve this plan** (or request changes)
2. **Setup local development environment**
3. **Create Supabase project**
4. **Initialize Next.js project**
5. **Start migration** (I can help with all of this!)
